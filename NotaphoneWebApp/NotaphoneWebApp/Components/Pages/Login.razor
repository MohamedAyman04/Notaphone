@page "/"
@rendermode InteractiveServer
@inject IDbContextFactory<ApplicationDbContext> DbFactory;
@inject ProtectedSessionStorage ProtectedSessionStore
@inject NavigationManager NavigationManager
@layout Layout.EmptyLayout

<PageTitle>Login</PageTitle>

<h1>Login</h1>

<div class="login">
    <input type="text" name="username" placeholder="mobile number" @bind="mobileNumber" />
    <input type="password" name="password" placeholder="password" @bind="password" />
    <button @onclick="submitInput">Submit</button>
    <p style="color: red">@error</p>
</div>

@if (loading)
{
    <div class="d-flex justify-content-center">
        <div class="spinner-border" style="color: #6c63ff" role="status">
            <span class="sr-only"></span>
        </div>
    </div>
}

@code {
    public string mobileNumber = "";
    public string password = "";
    public string error = "";
    public bool loading = false;

    async void submitInput() {
        loading = true;
        error = "";
        StateHasChanged();

        using var context = DbFactory.CreateDbContext();
        var list = await context.Database
             .SqlQuery<bool?>(
                 $"Select dbo.AccountLoginValidation({mobileNumber}, {password})"
             ).ToListAsync();

        if (mobileNumber == "admin" && password == "admin") {
            await ProtectedSessionStore.SetAsync("isCustomer", false);
        } else {
            await ProtectedSessionStore.SetAsync("isCustomer", true);
        }

        if ((await ProtectedSessionStore.GetAsync<bool>("isCustomer")).Value) {
            try {
                if (list[0].Value) {
                    await ProtectedSessionStore.SetAsync("mobileNumber", mobileNumber);
                    await ProtectedSessionStore.SetAsync("password", password);
                    NavigationManager.NavigateTo("/HomeCustomer");
                } else {
                    throw new Exception("Wrong Mobile Number Or Password");
                }
            }
            catch (Exception err) {
                error = err.Message;
                StateHasChanged();
            }
            finally {
                loading = false;
                StateHasChanged();
            }
        } else {
            NavigationManager.NavigateTo("/HomeAdmin");
        } 
    }
}